## STP协议详解

#### STP简介

**生成树协议(Spanning-Tree Protocol)** 是一种工作在OSI网络模型中的第二层(数据链路层)的通信协议，基本应用是防止交换机冗余链路产生的环路.用于确保以太网中无环路的逻辑拓扑结构.它的标准基于：
IEEE 802.1D STP
IEEE 802.1W RSTP  快速生成树
IEEE 802.1S MSTP  多生成树
由于局域网规模的不断增长，生成树协议已经成为了当前最重要的局域网协议之一。

#### 技术背景

+ **二层环路**
![技术背景](/源库/STP/技术背景.png)
![技术背景2](/源库/STP/技术背景.png)

+ **二层环路导致的广播风波和mac地址飘移**
![常见问题](/源库/STP/带来的问题.png)

交换机上运行的生成树协议会持续监控网络的拓扑结构，当网络拓扑结构发生变化时，生成树能感知到这些变化，并自动做出调整。当检测到无环时，会恢复接口，但是检测时间缓慢。因此，生成树既能解决二层环路问题，也能为网络的冗余性提供一种方案。

在网络中部署生成树后，交换机之间会进行生成树协议报文的交互并进行无环拓扑计算，最终将网络中某些接口进行堵塞，从而打破环路。因此，如果可以不使用STP解决问题，尽量不要使用生成树。

#### 辨析—二层环路和三层环路

+ **二层环路**

常见问题：网络中部署了二层冗余环境，或人为的误接导致.
需借助特定的协议或机制实现二层防环.
二层帧头中并没有任何信息可用于防止数据帧被无止尽地转发.

+ **三层环路**

常见问题：路由环路
动态路由协议有一定地防环能力，一般只需调整路由协议
IP报文头部中的TTL字段可以防止报文被无止尽的转发，不会出现二层环路时的广播风暴.

#### 基本概念

+ **桥ID(Bridge ID, BID)**
IEEE 802.1D 标准中规定BID由16位的桥优先级与桥MAC地址构成.
每一台运行STP的交换机都拥有一个唯一的BID.
在STP网络中，BID最小的设备会被选举为根桥.
</br>

+ **开销(Cost)**
每一个激活了STP的接口都维护着一个cost值.
![cost计算](/源库/STP/cost计算.png)
接口的cost值主要用于计算根路径开销，也就是达到根的开销.
接口带宽越大，则cost值越小.
用户也可以根据需要通过命令调整接口的cost.
</br>

+ **RPC(根路径开销)**
一台设备从某个接口到达根桥的PRC等于从根桥到该设备沿途所有入方向接口的Cost累加.
</br>

+ **接口ID(Port ID)**
运行STP的交换机使用接口ID来标识每个接口，接口ID主要用于特定场景下选举指定接口.
激活STP的接口会维护一个缺省的接口优先级，该值为128，可以根据需要通过命令修改.

#### BPDU(Bridge Protocol Data Unit,网桥协议数据单元)

+ **BPDU简介**
BPDU是STP能够正常工作的根本，是STP的协议报文。STP交换机之间会交互BPDU报文，这些报文携带着一些重要性息，正是基于这些信息，STP才能顺利工作。
BPDU分为两种类型：
配置BPDU(Configuration BPDU),由根桥发送每两秒一次，是STP进行拓扑计算的关键.
TCN BPDU(Topology Change Notification BPDU),由发现拓扑变更的交换机发送给根桥.

注：TCN BPDU是IEEE802.1D特有。

+ **配置BPDU报文**

![报文格式](/源库/STP/BPDU报文格式.png)
</br>

+ **BPDU报文的比较原则**
STP根据如下顺序选择最优的配置BPDU:
1.最小的根桥ID
2.最小的RPC
3.最小的网桥ID
4.最小的接口ID
第一条主要用于选举根桥，后面的主要用于选举根接口和指定接口。
</br>

+ **BPDU报文的转发过程**

![转发](/源库/STP/BPDU转发过程.png)

#### STP计算过程

+ **选举根桥**
  + STP在交换网络中开始工作后，每个交换机都会向网络中发送BPDU，配置BPDU中包含交换机自己的桥ID。
  + 网络中拥有最小桥ID的交换机成为根桥。
  + 在一个连续的STP交换网络中只会存在一个根桥。
  + 根桥的角色是可抢占的。
  + 为了确保交换网络的稳定，建议提前规划STP组网，并将规划为根桥的交换机的桥优先级设置为最小值0。
</br>

+ **选举根接口**
  + 每一台非根交换机都会在自己的接口中选举出一个端口
  + 非根桥交换机上有且只会有一个根端口
  + 当非根桥交换机有多个接口接入网络中时，根接口是其收到最优配置的BPDU的接口
  + 可以形象地理解为，根端口是每台非根桥上“朝向”根桥的端口
</br>

+ **选举指定端口**
  + 根接口选举出来之后，非根桥会使用其在该接口上收到的最优BPDU进行计算，然后将计算得到的配置BPDU进行计算，然后将计算得到的配置BPDU进行比较。
  + 由于STP在泛洪BPDU报文本身会产生环路，所以由根桥指定端口发送BPDU，非根桥根端口接收BPDU报文，再由指定端口转发。因此，一般根桥所有端口都是指定端口。
</br>

+ **堵塞非指定接口**
一台交换机上，既不是根端口，又不是指定端口的接口被称为非指定接口STP操作的
最后已不是阻塞网络中的非指定接口，这一步完成后，网络中的二层环路就此消除。

#### STP接口状态

+ **接口状态**

![接口状态](/源库/STP/接口状态.png)
</br>

+ **接口状态迁移**

![状态迁移](/源库/STP/接口状态迁移.png)

#### STP拓扑变更

+ **拓扑变更-根桥故障**

![根桥故障](/源库/STP/根桥故障.png)

下游交换机等待Max Age计时器(20s)超时，从而导致已经收到的BPDU报文失效，又接
收不到根桥发送的BPDU报文，从而得知上游出现故障。
非根桥会互相发送配置BPDU，重新选举新的根桥.
经过重新选举后，非根桥的根端口经过两个Forward Delay(15s)时间恢复转发状态。
即根桥故障会导致50s左右的恢复时间。

其实上面写的并不完全准确，实际上下游直连根桥的非根交换机在根桥故障(对端down)后会有所感知并立刻重新选举，但是由于交换机中还有原先根桥BPDU报文的缓存，因此，新接收的BPDU会成为次级BPDU。因此两个Forward Delay和Max Age同时计时，只要30s就能恢复。

+ **拓扑变更-直连链路故障**

![直连链路故障](/源库/STP/直连链路故障.png)

当备份根桥检测到根端口的链路发生故障，则其备用端口会经过两倍Forward Delay时间转换为根端口，只需30s就能恢复转发状态。
</br>

+ **拓扑变更-非直连链路故障**

![非直连链路故障](/源库/STP/非直连链路故障.png)

在Max Age计时器超时后，重新启用原先被阻塞的链路，通过指定端口再次转发BPDU报文给收不到根桥BPDU的交换机。经过两个Forward Dalay时间重新选举根端口。
</br>

+ **拓扑变更-mac地址表错误**

![mac地址表故障](/源库/STP/mac地址表错误.png)

当生成树因为拓扑变更重新收敛后，挂在交换机下的两台主机不能到达目的地，这是因为交换机依赖mac地址表转发数据帧，缺省情况下，mac地址表的老化时间是300秒。
TCN BPDU在网络拓扑变化的时候产生，调整域内所有老化计时器为15s。mac地址表项从而可以在生成树重新收敛之前完成变更。

#### STP基础配置

+ **STP的基础配置命令(Huawei)**

```shell
stp enable                                         //启用stp(华为默认)
stp mode {stp| rstp | mstp}                        //生成树工作模式，默认mstp
stp root primary                                   //手动设置根桥，打完后该交换机优先级为0
stp root secondary                                 //手动设置备份根桥
stp priority {优先级}                              //更改交换机优先级(BID),必须为16倍数，默认32768
stp pathcost-standard { dot1d-1998 | dot1t | legacy }  //配置路径开销计算方法，默认dot1t
stp cost {开销}                                      //更改接口的路径开销
stp priority {优先级}                                //更改接口优先级(PID),默认为128，必须为16倍数
display stp brief                                   //查看stp接口状态
```

#### STP的不足之处

![不足之处](/源库/STP/不足之处.png)

> 在思科的设备上STP会基于不同vlan分为不同进程，不同的生成树的进程所生成的拓扑
 只会为对应的vlan服务，从而达到负载均衡。因此，在一个网络内有多个不同厂商设备
运行STP会有兼容性问题，无法通过生成树解决冗余路径阻塞问题。但是如果都运行IEEE
802.1S的MSTP协议可以解决兼容性和速度的进程。
STP虽然能够解决环路问题，但是由于网络拓扑收敛慢，影响用户通信质量。如果拓扑结
构频繁变化，网络也会频繁失去联通性。

华为：CST通用生成树协议
Cisco：pvST基于VLAN的生成树协议

#### 拓展

不使用STP解决二层环路：

1. 使用大二层技术优化交换机控制层面，运行动态路由选择协议来防环。
2. iStack和CSS堆叠，形成逻辑上的单台设备，从而简化网络拓扑。
3. Smart Link(华为私有协议)

+ **堆叠组网**

![堆叠组网](/源库/STP/堆叠组网.png)
</br>

+ **Smart Link**

![smart link](/源库/STP/SmartLink.png)

配置部分详见：[华为官网Smart Link配置指南](https://support.huawei.com/enterprise/zh/doc/EDOC1100038437/2a1b7223)